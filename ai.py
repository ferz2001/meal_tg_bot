import logging

from openai import OpenAI

from config import settings


client = OpenAI(api_key=settings.OPENAI_API_KEY)
logging.basicConfig(level=logging.INFO)


async def ai_process_image_and_addition(image_data, additional_data):
    """
    Отправляет изображение и дополнение в OpenAI для обработки.

    Args:
        image_data (str): Изображение, закодированное в base64, которое будет отправлено в OpenAI для распознавания.
        additional_data (str): Дополнительные данные от пользователя, которые могут помочь в распознавании блюда.

    Returns:
        str: Ответ от OpenAI, содержащий JSON с данными о блюде (название, вес, калории и т.д.)
        или строку 'Блюдо не найдено'.

    """
    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {
                "role": "system",
                "content": (
                    "Ты — помощник по распознаванию блюд. "
                    "Если на фото нет блюда, но в дополнении указаны детали (например, 'кофе с молоком 300мл'), "
                    "используй информацию из дополнения для формирования ответа. "
                    "Если на фото нет явного блюда, но описание в дополнении даёт чёткие указания, "
                    "используй его в первую очередь, даже если на фото только стакан или неопределённый объект. "
                    "Если информация в дополнении чётко описывает блюдо, используй её для создания ответа, а не фото. "
                    "Если дополнение не даёт чёткой информации о блюде, верни строго: 'Блюдо не найдено'. "
                    "Если распознано блюдо, верни только JSON формата:\n"
                    "{\n"
                    "  \"название\": \"string\",\n"
                    "  \"вес_г\": 16,\n"
                    "  \"калории\": 52,\n"
                    "  \"белки_г\": 0.3,\n"
                    "  \"жиры_г\": 0.2,\n"
                    "  \"углеводы_г\": 14\n"
                    "}\n"
                    "Без дополнительных пояснений, без markdown. "
                )
            },
            {
                "role": "user",
                "content": [
                    {
                        "type": "text",
                        "text": (
                            "Определи, есть ли на фото блюдо. Если да — верни JSON, иначе — 'Блюдо не найдено'. "
                            "Если на фото нет блюда или информация о весе/составе неполная, используй данные, "
                            "предоставленные пользователем в виде дополнения. "
                            "Преимущественно возвращай информацию из дополнения, если она чётко указывает на блюдо, "
                            "даже если на фото этого блюда нет. "
                            "Если на фото нет блюда, и по дополнительной информации невозможно сформировать ответ, "
                            "верни строго: 'Блюдо не найдено'."
                        )
                    },
                    {
                        "type": "text",
                        "text": f"Дополнение: {additional_data}. "
                    },
                    {
                        "type": "image_url",
                        "image_url": {
                            "url": f"data:image/jpeg;base64,{image_data}",
                            "detail": "low"
                        }
                    }
                ]
            }
        ],
    )

    return response.choices[0].message.content.strip()
